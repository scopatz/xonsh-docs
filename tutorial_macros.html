

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Tutorial: Macros &#8212; xonsh 0.4.6 documentation</title>
    
    <link rel="stylesheet" href="_static/numpy_friendly.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noticia+Text|Open+Sans|Droid+Sans+Mono" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.4.6',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/jquery.cookie.js"></script>
    <script type="text/javascript" src="_static/cloud.js"></script>
    <link rel="shortcut icon" href="_static/magic_conch.ico"/>
    <link rel="top" title="xonsh 0.4.6 documentation" href="index.html" />
    <link rel="next" title="Tutorial: Extensions (Xontribs)" href="tutorial_xontrib.html" />
    <link rel="prev" title="Tutorial: History" href="tutorial_hist.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body role="document">
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="tutorial_xontrib.html" title="Tutorial: Extensions (Xontribs)"
             accesskey="N">next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="tutorial_hist.html" title="Tutorial: History"
             accesskey="P">previous</a> &nbsp; &nbsp;</li>
    <li><a href="index.html">xonsh 0.4.6 documentation</a> &#187;</li>
 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="tutorial-macros">
<span id="id1"></span><h1>Tutorial: Macros<a class="headerlink" href="#tutorial-macros" title="Permalink to this headline">¶</a></h1>
<p>Bust out your DSLRs, people. It is time to closely examine macros!</p>
<div class="section" id="what-are-macro-instructions">
<h2>What are macro instructions?<a class="headerlink" href="#what-are-macro-instructions" title="Permalink to this headline">¶</a></h2>
<p>In generic terms, a programming macro is a special kind of syntax that
replaces a smaller amount of code with a larger expression, syntax tree,
code object, etc after the macro has been evaluated.
In practice, macros pause the normal parsing and evaluation of the code
that they contain. This is so that they can perform their expansion with
a complete inputs. Roughly, the algorithm executing a macro follows is:</p>
<ol class="arabic simple">
<li>Macro start, pause or skip normal parsing</li>
<li>Gather macro inputs as strings</li>
<li>Evaluate macro with inputs</li>
<li>Resume normal parsing and execution.</li>
</ol>
<p>Is this meta-programming? You betcha!</p>
</div>
<div class="section" id="when-and-where-are-macros-used">
<h2>When and where are macros used?<a class="headerlink" href="#when-and-where-are-macros-used" title="Permalink to this headline">¶</a></h2>
<p>Macros are a practicality-beats-purity feature of many programing
languages. Because they allow you break out of the normal parsing
cycle, depending on the language, you can do some truly wild things with
them. However, macros are really there to reduce the amount of boiler plate
code that users and developers have to write.</p>
<p>In C and C++ (and Fortran), the C Preprocessor <code class="docutils literal"><span class="pre">cpp</span></code> is a macro evaluation
engine. For example, every time you see an <code class="docutils literal"><span class="pre">#include</span></code> or <code class="docutils literal"><span class="pre">#ifdef</span></code>, this is
the <code class="docutils literal"><span class="pre">cpp</span></code> macro system in action.
In these languages, the macros are technically outside of the definition
of the language at hand. Furthermore, because <code class="docutils literal"><span class="pre">cpp</span></code> must function with only
a single pass through the code, the sorts of macros that can be written with
<code class="docutils literal"><span class="pre">cpp</span></code> are relatively simple.</p>
<p>Rust, on the other hand, has a first-class notion of macros that look and
feel a lot like normal functions. Macros in Rust are capable of pulling off
type information from their arguments and preventing their return values
from being consumed.</p>
<p>Other languages like Lisp, Forth, and Julia also provide their macro systems.
Even restructured text (rST) directives could be considered macros.
Haskell and other more purely functional languages do not need macros (since
evaluation is lazy anyway), and so do not have them.</p>
<p>If these seem unfamiliar to the Python world, note that Jupyter and IPython
magics <code class="docutils literal"><span class="pre">%</span></code> and <code class="docutils literal"><span class="pre">%%</span></code> are macros!</p>
</div>
<div class="section" id="function-macros">
<h2>Function Macros<a class="headerlink" href="#function-macros" title="Permalink to this headline">¶</a></h2>
<p>Xonsh supports Rust-like macros that are based on normal Python callables.
Macros do not require a special definition in xonsh. However, like in Rust,
they must be called with an exclamation point <code class="docutils literal"><span class="pre">!</span></code> between the callable
and the opening parentheses <code class="docutils literal"><span class="pre">(</span></code>. Macro arguments are split on the top-level
commas <code class="docutils literal"><span class="pre">,</span></code>, like normal Python functions.  For example, say we have the
functions <code class="docutils literal"><span class="pre">f</span></code> and <code class="docutils literal"><span class="pre">g</span></code>. We could perform a macro call on these functions
with the following:</p>
<div class="highlight-xonsh"><div class="highlight"><pre><span></span># No macro args
f!()

# Single arg
f!(x)
g!([y, 43, 44])

# Two args
f!(x, x + 42)
g!([y, 43, 44], f!(z))
</pre></div>
</div>
<p>Not so bad, right?  So what actually happens to the arguments when used
in a macro call?  Well, that depends on the definition of the function. In
particular, each argument in the macro call is matched up with the corresponding
parameter annotation in the callable&#8217;s signature.  For example, say we have
an <code class="docutils literal"><span class="pre">identity()</span></code> function that annotates its sole argument as a string:</p>
<div class="highlight-xonsh"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">identity</span><span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
<p>If we call this normally, we&#8217;ll just get whatever object we put in back out,
even if that object is not a string:</p>
<div class="highlight-xonshcon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">identity</span><span class="p">(</span><span class="s1">&#39;me&#39;</span><span class="p">)</span><span class="go"></span>
<span class="go">&#39;me&#39;</span>

<span class="gp">&gt;&gt;&gt;</span> <span class="n">identity</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span><span class="go"></span>
<span class="go">42</span>

<span class="gp">&gt;&gt;&gt;</span> <span class="n">identity</span><span class="p">(</span><span class="n">identity</span><span class="p">)</span><span class="go"></span>
<span class="go">&lt;function __main__.identity&gt;</span>
</pre></div>
</div>
<p>However, if we perform macro calls instead we are now guaranteed to get
the string of the source code that is in the macro call:</p>
<div class="highlight-xonshcon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">identity</span><span class="k">!(</span><span class="s1">&#39;me&#39;</span><span class="k">)</span><span class="go"></span>
<span class="go">&quot;&#39;me&#39;&quot;</span>

<span class="gp">&gt;&gt;&gt;</span> <span class="n">identity</span><span class="k">!(</span><span class="m">42</span><span class="k">)</span><span class="go"></span>
<span class="go">&#39;42&#39;</span>

<span class="gp">&gt;&gt;&gt;</span> <span class="n">identity</span><span class="k">!(</span>identity<span class="k">)</span><span class="go"></span>
<span class="go">&#39;identity&#39;</span>
</pre></div>
</div>
<p>Also note that each macro argument is stripped prior to passing it to the
macro itself. This is done for consistency.</p>
<div class="highlight-xonshcon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">identity</span><span class="k">!(</span><span class="m">42</span><span class="k">)</span><span class="go"></span>
<span class="go">&#39;42&#39;</span>

<span class="gp">&gt;&gt;&gt;</span> <span class="n">identity</span><span class="k">!(</span>  <span class="m">42</span> <span class="k">)</span><span class="go"></span>
<span class="go">&#39;42&#39;</span>
</pre></div>
</div>
<p>Importantly, because we are capturing and not evaluating the source code,
a macro call can contain input that is beyond the usual syntax. In fact, that
is sort of the whole point. Here are some cases to start your gears turning:</p>
<div class="highlight-xonshcon"><div class="highlight"><pre><span></span>&gt;&gt;&gt; identity!(import os)
&#39;import os&#39;

&gt;&gt;&gt; identity!(if True:
&gt;&gt;&gt;     pass)
&#39;if True:\n    pass&#39;

&gt;&gt;&gt; identity!(std::vector&lt;std::string&gt; x = {&quot;yoo&quot;, &quot;hoo&quot;})
&#39;std::vector&lt;std::string&gt; x = {&quot;yoo&quot;, &quot;hoo&quot;}&#39;
</pre></div>
</div>
<p>You do you, <code class="docutils literal"><span class="pre">identity()</span></code>.</p>
</div>
<div class="section" id="calling-function-macros">
<h2>Calling Function Macros<a class="headerlink" href="#calling-function-macros" title="Permalink to this headline">¶</a></h2>
<p>There are a couple of points to consider when calling macros. The first is
that passing in arguments by name will not behave as expected. This is because
the <code class="docutils literal"><span class="pre">&lt;name&gt;=</span></code> is captured by the macro itself. Using the <code class="docutils literal"><span class="pre">identity()</span></code>
function from above:</p>
<div class="highlight-xonshcon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">identity</span><span class="k">!(</span><span class="nv">x</span><span class="o">=</span><span class="m">42</span><span class="k">)</span><span class="go"></span>
<span class="go">&#39;x=42&#39;</span>
</pre></div>
</div>
<p>Performing a macro call uses only argument order to pass in values.</p>
<p>Additionally, macro calls split arguments only on the top-level commas.
The top-level commas are not included in any argument.
This behaves analogously to normal Python function calls. For instance,
say we have the following <code class="docutils literal"><span class="pre">g()</span></code> function that accepts two arguments:</p>
<div class="highlight-xonsh"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">y</span> <span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;x = &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;y = &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
</pre></div>
</div>
<p>Then you can see the splitting and stripping behavior on each macro
argument:</p>
<div class="highlight-xonshcon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">g</span><span class="k">!(</span>42, <span class="m">65</span><span class="k">)</span><span class="go"></span>
<span class="go">x = &#39;42&#39;</span>
<span class="go">y = &#39;65&#39;</span>

<span class="gp">&gt;&gt;&gt;</span> <span class="n">g</span><span class="k">!(</span>42, 65,<span class="k">)</span><span class="go"></span>
<span class="go">x = &#39;42&#39;</span>
<span class="go">y = &#39;65&#39;</span>

<span class="gp">&gt;&gt;&gt;</span> <span class="n">g</span><span class="k">!(</span> 42, 65, <span class="k">)</span><span class="go"></span>
<span class="go">x = &#39;42&#39;</span>
<span class="go">y = &#39;65&#39;</span>

<span class="gp">&gt;&gt;&gt;</span> <span class="n">g</span><span class="k">!(</span><span class="o">[</span><span class="s1">&#39;x&#39;</span>, <span class="s1">&#39;y&#39;</span><span class="o">]</span>, <span class="o">{</span>1: 1, 2: 3<span class="o">}</span><span class="k">)</span><span class="go"></span>
<span class="go">x = &quot;[&#39;x&#39;, &#39;y&#39;]&quot;</span>
<span class="go">y = &#39;{1: 1, 2: 3}&#39;</span>
</pre></div>
</div>
<p>Sometimes you may only want to pass in the first few arguments as macro
arguments and you want the rest to be treated as normal Python arguments.
By convention, xonsh&#8217;s macro caller will look for a lone <code class="docutils literal"><span class="pre">*</span></code> argument
in order to split the macro arguments and the regular arguments. So for
example:</p>
<div class="highlight-xonshcon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">g</span><span class="k">!(</span>42, *, <span class="m">65</span><span class="k">)</span><span class="go"></span>
<span class="go">x = &#39;42&#39;</span>
<span class="go">y = 65</span>

<span class="gp">&gt;&gt;&gt;</span> <span class="n">g</span><span class="k">!(</span>42, *, <span class="nv">y</span><span class="o">=</span><span class="m">65</span><span class="k">)</span><span class="go"></span>
<span class="go">x = &#39;42&#39;</span>
<span class="go">y = 65</span>
</pre></div>
</div>
<p>In the above, note that <code class="docutils literal"><span class="pre">x</span></code> is still captured as a macro argument. However,
everything after the <code class="docutils literal"><span class="pre">*</span></code>, namely <code class="docutils literal"><span class="pre">y</span></code>, is evaluated is if it were passed
in to a normal function call.  This can be useful for large interfaces where
only a handful of args are expected as macro arguments.</p>
<p>Hopefully, now you see the big picture.</p>
</div>
<div class="section" id="writing-function-macros">
<h2>Writing Function Macros<a class="headerlink" href="#writing-function-macros" title="Permalink to this headline">¶</a></h2>
<p>Though any function (or callable) can be used as a macro, this functionality
is probably most useful if the function was <em>designed</em> as a macro. There
are two main aspects of macro design to consider: argument annotations and
call site execution context.</p>
<div class="section" id="macro-function-argument-annotations">
<h3>Macro Function Argument Annotations<a class="headerlink" href="#macro-function-argument-annotations" title="Permalink to this headline">¶</a></h3>
<p>There are six kinds of annotations that macros are able to interpret:</p>
<table border="1" class="docutils" id="id2">
<caption><span class="caption-text">Kinds of Annotation</span><a class="headerlink" href="#id2" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="20%" />
<col width="20%" />
<col width="20%" />
<col width="20%" />
<col width="20%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Category</th>
<th class="head">Object</th>
<th class="head">Flags</th>
<th class="head">Modes</th>
<th class="head">Returns</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>String</td>
<td><code class="docutils literal"><span class="pre">str</span></code></td>
<td><code class="docutils literal"><span class="pre">'s'</span></code>, <code class="docutils literal"><span class="pre">'str'</span></code>, or <code class="docutils literal"><span class="pre">'string'</span></code></td>
<td>&nbsp;</td>
<td>Source code of argument as string.</td>
</tr>
<tr class="row-odd"><td>AST</td>
<td><code class="docutils literal"><span class="pre">ast.AST</span></code></td>
<td><code class="docutils literal"><span class="pre">'a'</span></code> or <code class="docutils literal"><span class="pre">'ast'</span></code></td>
<td><code class="docutils literal"><span class="pre">'eval'</span></code> (default), <code class="docutils literal"><span class="pre">'exec'</span></code>, or <code class="docutils literal"><span class="pre">'single'</span></code></td>
<td>Abstract syntax tree of argument.</td>
</tr>
<tr class="row-even"><td>Code</td>
<td><code class="docutils literal"><span class="pre">types.CodeType</span></code> or <code class="docutils literal"><span class="pre">compile</span></code></td>
<td><code class="docutils literal"><span class="pre">'c'</span></code>, <code class="docutils literal"><span class="pre">'code'</span></code>, or <code class="docutils literal"><span class="pre">'compile'</span></code></td>
<td><code class="docutils literal"><span class="pre">'eval'</span></code> (default), <code class="docutils literal"><span class="pre">'exec'</span></code>, or <code class="docutils literal"><span class="pre">'single'</span></code></td>
<td>Compiled code object of argument.</td>
</tr>
<tr class="row-odd"><td>Eval</td>
<td><code class="docutils literal"><span class="pre">eval</span></code> or <code class="docutils literal"><span class="pre">None</span></code></td>
<td><code class="docutils literal"><span class="pre">'v'</span></code> or <code class="docutils literal"><span class="pre">'eval'</span></code></td>
<td>&nbsp;</td>
<td>Evaluation of the argument, <em>default</em>.</td>
</tr>
<tr class="row-even"><td>Exec</td>
<td><code class="docutils literal"><span class="pre">exec</span></code></td>
<td><code class="docutils literal"><span class="pre">'x'</span></code> or <code class="docutils literal"><span class="pre">'exec'</span></code></td>
<td><code class="docutils literal"><span class="pre">'exec'</span></code> (default) or <code class="docutils literal"><span class="pre">'single'</span></code></td>
<td>Execs the argument and returns None.</td>
</tr>
<tr class="row-odd"><td>Type</td>
<td><code class="docutils literal"><span class="pre">type</span></code></td>
<td><code class="docutils literal"><span class="pre">'t'</span></code> or <code class="docutils literal"><span class="pre">'type'</span></code></td>
<td>&nbsp;</td>
<td>The type of the argument after it has been evaluated.</td>
</tr>
</tbody>
</table>
<p>These annotations allow you to hook into whichever stage of the compilation
that you desire. It is important to note that the string form of the arguments
is split and stripped (as described above) prior to conversion to the
annotation type.</p>
<p>Each argument may be annotated with its own individual type. Annotations
may be provided as either objects or as the string flags seen in the above
table. String flags are case-insensitive.
If an argument does not have an annotation, <code class="docutils literal"><span class="pre">eval</span></code> is selected.
This makes the macro call behave like a normal function call for
arguments whose annotations are unspecified.  For example,</p>
<div class="highlight-xonsh"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="p">:</span> <span class="s1">&#39;AST&#39;</span><span class="p">,</span> <span class="n">c</span> <span class="p">:</span> <span class="nb">compile</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>In a macro call of <code class="docutils literal"><span class="pre">func!()</span></code>,</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">a</span></code> will be evaluated with <code class="docutils literal"><span class="pre">eval</span></code> since no annotation was provided,</li>
<li><code class="docutils literal"><span class="pre">b</span></code> will be parsed into a syntax tree node, and</li>
<li><code class="docutils literal"><span class="pre">c</span></code> will be compiled into code object since the builtin <code class="docutils literal"><span class="pre">compile()</span></code>
function was used as the annotation.</li>
</ul>
<p>Additionally, certain kinds of annotations have different modes that
affect the parsing, compilation, and execution of its argument.  While a
sensible default is provided, you may also supply your own. This is
done by annotating with a (kind, mode) tuple.  The first element can
be any valid object or flag. The second element must be a corresponding
mode as a string.  For instance,</p>
<div class="highlight-xonsh"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">gunc</span><span class="p">(</span><span class="n">d</span> <span class="p">:</span> <span class="p">(</span><span class="k">exec</span><span class="p">,</span> <span class="s1">&#39;single&#39;</span><span class="p">),</span> <span class="n">e</span> <span class="p">:</span> <span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)):</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>Thus in a macro call of <code class="docutils literal"><span class="pre">gunc!()</span></code>,</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">d</span></code> will be exec&#8217;d in single-mode (rather than exec-mode), and</li>
<li><code class="docutils literal"><span class="pre">e</span></code> will be compiled in exec-mode (rather than eval-mode).</li>
</ul>
<p>For more information on the differences between the exec, eval, and single
modes please see the Python documentation.</p>
</div>
<div class="section" id="macro-function-execution-context">
<h3>Macro Function Execution Context<a class="headerlink" href="#macro-function-execution-context" title="Permalink to this headline">¶</a></h3>
<p>Equally important as having the macro arguments is knowing the execution
context of the macro call itself. Rather than mucking around with frames,
macros provide both the globals and locals of the call site.  These are
accessible as the <code class="docutils literal"><span class="pre">macro_globals</span></code> and <code class="docutils literal"><span class="pre">macro_locals</span></code> attributes of
the macro function itself while the macro is being executed.</p>
<p>For example, consider a macro which replaces all literal <code class="docutils literal"><span class="pre">1</span></code> digits
with the literal <code class="docutils literal"><span class="pre">2</span></code>, evaluates the modification, and returns the results.
To eval, the macro will need to pull off its globals and locals:</p>
<div class="highlight-xonsh"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">one_to_two</span><span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">)</span>
    <span class="n">glbs</span> <span class="o">=</span> <span class="n">one_to_two</span><span class="o">.</span><span class="n">macro_globals</span>
    <span class="n">locs</span> <span class="o">=</span> <span class="n">one_to_two</span><span class="o">.</span><span class="n">macro_locals</span>
    <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">glbs</span><span class="p">,</span> <span class="n">locs</span><span class="p">)</span>
</pre></div>
</div>
<p>Running this with a few of different inputs, we see:</p>
<div class="highlight-xonshcon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">one_to_two</span><span class="k">!(</span><span class="m">1</span> + <span class="m">1</span><span class="k">)</span><span class="go"></span>
<span class="go">4</span>

<span class="gp">&gt;&gt;&gt;</span> <span class="n">one_to_two</span><span class="k">!(</span><span class="m">11</span><span class="k">)</span><span class="go"></span>
<span class="go">22</span>

<span class="gp">&gt;&gt;&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="gp"></span>
<span class="gp">&gt;&gt;&gt;</span> <span class="n">one_to_two</span><span class="k">!(</span>x + <span class="m">1</span><span class="k">)</span><span class="go"></span>
<span class="go">3</span>
</pre></div>
</div>
<p>Of course, many other more sophisticated options are available depending on the
use case.</p>
</div>
</div>
<div class="section" id="subprocess-macros">
<h2>Subprocess Macros<a class="headerlink" href="#subprocess-macros" title="Permalink to this headline">¶</a></h2>
<p>Like with function macros above, subprocess macros allow you to pause the parser
for until you are ready to exit subprocess mode. Unlike function macros, there
is only a single macro argument and its macro type is always a string.  This
is because it (usually) doesn&#8217;t make sense to pass non-string arguments to a
command. And when it does, there is the <code class="docutils literal"><span class="pre">&#64;()</span></code> syntax!</p>
<p>In the simplest case, subprocess macros look like the equivalent of their
function macro counterparts:</p>
<div class="highlight-xonshcon"><div class="highlight"><pre><span></span>&gt;&gt;&gt; echo! I&#39;m Mr. Meeseeks.
I&#39;m Mr. Meeseeks.
</pre></div>
</div>
<p>Again, note that everything to the right of the <code class="docutils literal"><span class="pre">!</span></code> is passed down to the
<code class="docutils literal"><span class="pre">echo</span></code> command as the final, single argument. This is space preserving,
like wrapping with quotes:</p>
<div class="highlight-xonshcon"><div class="highlight"><pre><span></span># normally, xonsh will split on whitespace,
# so each argument is passed in separately
&gt;&gt;&gt; echo x  y       z
x y z

# usually space can be preserved with quotes
&gt;&gt;&gt; echo &quot;x  y       z&quot;
x  y       z

# however, subprocess macros will pause and then strip
# all input after the exclamation point
&gt;&gt;&gt; echo! x  y       z
x  y       z
</pre></div>
</div>
<p>However, the macro will pause everything, including path and environment variable
expansion, that might be present even with quotes.  For example:</p>
<div class="highlight-xonshcon"><div class="highlight"><pre><span></span># without macros, environment variable are expanded
&gt;&gt;&gt; echo $USER
lou

# inside of a macro, all additional munging is turned off.
&gt;&gt;&gt; echo! $USER
$USER
</pre></div>
</div>
<p>Everything to the right of the exclamation point, except the leading and trailing
whitespace, is passed into the command directly as written. This allows certain
commands to function in cases where quoting or piping might be more burdensome.
The <code class="docutils literal"><span class="pre">timeit</span></code> command is a great example where simple syntax will often fail,
but will be easily executable as a macro:</p>
<div class="highlight-xonshcon"><div class="highlight"><pre><span></span># fails normally
&gt;&gt;&gt; timeit &quot;hello mom &quot; + &quot;and dad&quot;
xonsh: subprocess mode: command not found: hello

# macro success!
&gt;&gt;&gt; timeit! &quot;hello mom &quot; + &quot;and dad&quot;
100000000 loops, best of 3: 8.24 ns per loop
</pre></div>
</div>
<p>All expressions to the left of the exclamation point are passed in normally and
are not treated as the special macro argument. This allows the mixing of
simple and complex command line arguments. For example, sometimes you might
really want to write some code in another language:</p>
<div class="highlight-xonshcon"><div class="highlight"><pre><span></span># don&#39;t worry, it is temporary!
&gt;&gt;&gt; bash -c ! export var=42; echo $var
42

# that&#39;s better!
&gt;&gt;&gt; python -c ! import os; print(os.path.abspath(&quot;/&quot;))
/
</pre></div>
</div>
<p>Compared to function macros, subprocess macros are relatively simple.
However, they can still be very expressive!</p>
</div>
<div class="section" id="take-away">
<h2>Take Away<a class="headerlink" href="#take-away" title="Permalink to this headline">¶</a></h2>
<p>Hopefully, at this point, you see that a few well placed macros can be extremely
convenient and valuable to any project.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
        <p class="logo"><a href="index.html" title="index">
          <img class="logo" src="_static/ascii_conch_part_color_tight.png" alt="Logo"/>
        </a></p><div class="sphinxlocaltoc">
    <h3><a href="index.html">Page contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Tutorial: Macros</a><ul>
<li><a class="reference internal" href="#what-are-macro-instructions">What are macro instructions?</a></li>
<li><a class="reference internal" href="#when-and-where-are-macros-used">When and where are macros used?</a></li>
<li><a class="reference internal" href="#function-macros">Function Macros</a></li>
<li><a class="reference internal" href="#calling-function-macros">Calling Function Macros</a></li>
<li><a class="reference internal" href="#writing-function-macros">Writing Function Macros</a><ul>
<li><a class="reference internal" href="#macro-function-argument-annotations">Macro Function Argument Annotations</a></li>
<li><a class="reference internal" href="#macro-function-execution-context">Macro Function Execution Context</a></li>
</ul>
</li>
<li><a class="reference internal" href="#subprocess-macros">Subprocess Macros</a></li>
<li><a class="reference internal" href="#take-away">Take Away</a></li>
</ul>
</li>
</ul>

  </div>
  <div class="sphinxprev">
    <h4>Previous page</h4>
    <p class="topless"><a href="tutorial_hist.html"
                          title="Previous page">&larr; Tutorial: History</a></p>
  </div>
  <div class="sphinxnext">
    <h4>Next page</h4>
    <p class="topless"><a href="tutorial_xontrib.html"
                          title="Next page">&rarr; Tutorial: Extensions (Xontribs)</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/tutorial_macros.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="tutorial_xontrib.html" title="Tutorial: Extensions (Xontribs)"
             >next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="tutorial_hist.html" title="Tutorial: History"
             >previous</a> &nbsp; &nbsp;</li>
    <li><a href="index.html">xonsh 0.4.6 documentation</a> &#187;</li>
 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2015, Anthony Scopatz.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.6.
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>